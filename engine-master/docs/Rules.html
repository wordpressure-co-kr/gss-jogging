<!DOCTYPE html>

<html>
<head>
  <title>Rules.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docs.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Document.html">
                Document.coffee
              </a>
            
              
              <a class="source" href="Engine.html">
                Engine.coffee
              </a>
            
              
              <a class="source" href="Parser.html">
                Parser.coffee
              </a>
            
              
              <a class="source" href="Solver.html">
                Solver.coffee
              </a>
            
              
              <a class="source" href="Algebra.html">
                Algebra.coffee
              </a>
            
              
              <a class="source" href="Constraints.html">
                Constraints.coffee
              </a>
            
              
              <a class="source" href="Conventions.html">
                Conventions.coffee
              </a>
            
              
              <a class="source" href="Measurements.html">
                Measurements.coffee
              </a>
            
              
              <a class="source" href="Native.html">
                Native.coffee
              </a>
            
              
              <a class="source" href="Rules.html">
                Rules.coffee
              </a>
            
              
              <a class="source" href="Selectors.html">
                Selectors.coffee
              </a>
            
              
              <a class="source" href="Transformations.html">
                Transformations.coffee
              </a>
            
              
              <a class="source" href="Types.html">
                Types.coffee
              </a>
            
              
              <a class="source" href="Units.html">
                Units.coffee
              </a>
            
              
              <a class="source" href="Buffer.html">
                Buffer.coffee
              </a>
            
              
              <a class="source" href="Command.html">
                Command.coffee
              </a>
            
              
              <a class="source" href="Console.html">
                Console.coffee
              </a>
            
              
              <a class="source" href="EventTrigger.html">
                EventTrigger.coffee
              </a>
            
              
              <a class="source" href="Helper.html">
                Helper.coffee
              </a>
            
              
              <a class="source" href="Property.html">
                Property.coffee
              </a>
            
              
              <a class="source" href="Style.html">
                Style.coffee
              </a>
            
              
              <a class="source" href="Expressions.html">
                Expressions.coffee
              </a>
            
              
              <a class="source" href="Queries.html">
                Queries.coffee
              </a>
            
              
              <a class="source" href="Values.html">
                Values.coffee
              </a>
            
              
              <a class="source" href="Restyles.html">
                Restyles.coffee
              </a>
            
              
              <a class="source" href="Solutions.html">
                Solutions.coffee
              </a>
            
              
              <a class="source" href="Dimensions.html">
                Dimensions.coffee
              </a>
            
              
              <a class="source" href="Equasions.html">
                Equasions.coffee
              </a>
            
              
              <a class="source" href="Styles.html">
                Styles.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Rules.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>CSS rules and conditions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>GSS.Parser = <span class="hljs-built_in">require</span> <span class="hljs-string">'ccss-compiler'</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Rules</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Comma combines results of multiple selectors without duplicates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-string">','</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>If all sub-selectors are native, make a single comma separated selector</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">group</span>: <span class="hljs-string">'$query'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Separate arguments with commas during serialization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">separator</span>: <span class="hljs-string">','</span>

    <span class="hljs-attribute">serialized</span>: <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Dont let undefined arguments stop execution</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">eager</span>: <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Return deduplicated collection of all found elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">command</span>: <span class="hljs-function"><span class="hljs-params">(operation, continuation, scope, meta)</span> -&gt;</span>
      contd = <span class="hljs-property">@getScopePath</span>(continuation) + operation.path
      <span class="hljs-keyword">return</span> <span class="hljs-property">@queries</span>.get(contd)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Recieve a single element found by one of sub-selectors
Duplicates are stored separately, they dont trigger callbacks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">capture</span>: <span class="hljs-function"><span class="hljs-params">(result, operation, continuation, scope, meta)</span> -&gt;</span> 
      
      contd = <span class="hljs-property">@getScopePath</span>(continuation) + operation.parent.path
      <span class="hljs-property">@queries</span>.add(result, contd, operation.parent, scope, <span class="hljs-literal">true</span>)
      <span class="hljs-keyword">return</span> contd + <span class="hljs-property">@identify</span>(result) <span class="hljs-keyword">if</span> meta == <span class="hljs-property">@UP</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Remove a single element that was found by sub-selector
Doesnt trigger callbacks if it was also found by other selector</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">release</span>: <span class="hljs-function"><span class="hljs-params">(result, operation, continuation, scope)</span> -&gt;</span>
      contd = <span class="hljs-property">@getScopePath</span>(continuation) + operation.parent.path
      <span class="hljs-property">@queries</span>.remove(result, contd, operation.parent, scope, <span class="hljs-literal">true</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Conditionals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  <span class="hljs-string">"rule"</span>:
    <span class="hljs-attribute">bound</span>: <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Set rule body scope to a found element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">evaluate</span>: <span class="hljs-function"><span class="hljs-params">(operation, continuation, scope, meta, ascender, ascending)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> operation.index == <span class="hljs-number">2</span> &amp;&amp; !ascender
        <span class="hljs-property">@expressions</span>.evaluate operation, continuation, ascending, operation
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Capture commands generated by css rule conditional branch</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">capture</span>: <span class="hljs-function"><span class="hljs-params">(result, parent, continuation, scope)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> !result.nodeType &amp;&amp; !<span class="hljs-property">@isCollection</span>(result)
        <span class="hljs-property">@expressions</span>.push result
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="conditional-structure">Conditional structure</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  Evaluates one <span class="hljs-keyword">of</span> two branches
  chosen <span class="hljs-keyword">by</span> truthiness <span class="hljs-keyword">of</span> condition,
  which <span class="hljs-keyword">is</span> stored as dom query

  Invisible to solver, 
  it leaves trail <span class="hljs-keyword">in</span> continuation path</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-string">"if"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Resolve all values in first argument</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">primitive</span>: <span class="hljs-number">1</span>

    <span class="hljs-attribute">cleaning</span>: <span class="hljs-literal">true</span>

    <span class="hljs-attribute">subscribe</span>: <span class="hljs-function"><span class="hljs-params">(operation, continuation, scope = <span class="hljs-property">@scope</span>)</span> -&gt;</span>
      id = scope._gss_id
      watchers = <span class="hljs-property">@queries</span>._watchers[id] ||= []
      <span class="hljs-keyword">if</span> !watchers.length || <span class="hljs-property">@values</span>.indexOf(watchers, operation, continuation, scope) == -<span class="hljs-number">1</span>
        watchers.push operation, continuation, scope</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Capture commands generated by evaluation of arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">capture</span>: <span class="hljs-function"><span class="hljs-params">(result, operation, continuation, scope, meta)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Condition result bubbled up, pick a branch</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> operation.index == <span class="hljs-number">1</span>
        <span class="hljs-property">@commands</span>.<span class="hljs-keyword">if</span>.branch.call(@, operation.parent[<span class="hljs-number">1</span>], continuation, scope, meta, <span class="hljs-literal">undefined</span>, result)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
      <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Capture commands bubbled up from branches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> result == <span class="hljs-string">'object'</span> &amp;&amp; !result.nodeType &amp;&amp; !<span class="hljs-property">@isCollection</span>(result)
          <span class="hljs-property">@expressions</span>.push result
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

    <span class="hljs-attribute">branch</span>: <span class="hljs-function"><span class="hljs-params">(operation, continuation, scope, meta, ascender, ascending)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Subscribe </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@commands</span>.<span class="hljs-keyword">if</span>.subscribe.call(@, operation.parent, continuation, scope)
      operation.parent.uid ||= <span class="hljs-string">'@'</span> + (<span class="hljs-property">@commands</span>.uid = (<span class="hljs-property">@commands</span>.uid ||= <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>)
      condition = ascending &amp;&amp; (<span class="hljs-keyword">typeof</span> ascending != <span class="hljs-string">'object'</span> || ascending.length != <span class="hljs-number">0</span>)
      path = continuation + operation.parent.uid
      query = <span class="hljs-property">@queries</span>[path]
      <span class="hljs-keyword">if</span> query == <span class="hljs-literal">undefined</span> || (!!query != !!condition)
        index = condition &amp;&amp; <span class="hljs-number">2</span> || <span class="hljs-number">3</span>
        <span class="hljs-property">@engine</span>.<span class="hljs-built_in">console</span>.group <span class="hljs-string">'%s \t\t\t\t%o\t\t\t%c%s'</span>, <span class="hljs-property">@engine</span>.DOWN, operation.parent[index], <span class="hljs-string">'font-weight: normal; color: #999'</span>, continuation
        <span class="hljs-keyword">unless</span> query == <span class="hljs-literal">undefined</span>
          <span class="hljs-property">@queries</span>.clean(path, continuation, operation.parent, scope)
        <span class="hljs-keyword">if</span> branch = operation.parent[index]
          <span class="hljs-property">@expressions</span>.evaluate branch, path, scope, meta
        <span class="hljs-property">@console</span>.groupEnd(path)

        <span class="hljs-property">@queries</span>[path] = condition ? <span class="hljs-literal">null</span>

  <span class="hljs-string">"text/gss-ast"</span>: <span class="hljs-function"><span class="hljs-params">(source)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> JSON.parse(source)

  <span class="hljs-string">"text/gss"</span>: <span class="hljs-function"><span class="hljs-params">(source)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> GSS.Parser.parse(source)?.commands</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Evaluate stylesheet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-string">"eval"</span>: 
    <span class="hljs-attribute">command</span>: (operation, continuation, scope, meta, 
              node, type = <span class="hljs-string">'text/gss'</span>, source, label = type)<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">if</span> node.nodeType
        <span class="hljs-keyword">if</span> nodeType = node.getAttribute(<span class="hljs-string">'type'</span>)
          type = nodeType
        source ||= node.textContent || node 
        <span class="hljs-keyword">if</span> (nodeContinuation = node._continuation)?
          <span class="hljs-property">@queries</span>.clean(nodeContinuation)
          continuation = nodeContinuation
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> !operation
          continuation = <span class="hljs-property">@getContinuation</span>(node.tagName.toLowerCase(), node)
        <span class="hljs-keyword">else</span>
          continuation = node._continuation = <span class="hljs-property">@getContinuation</span>(continuation || <span class="hljs-string">''</span>, <span class="hljs-literal">null</span>,  <span class="hljs-property">@engine</span>.DOWN)
        <span class="hljs-keyword">if</span> node.getAttribute(<span class="hljs-string">'scoped'</span>)?
          scope = node.parentNode

      rules = @[<span class="hljs-string">'_'</span> + type](source)
      <span class="hljs-property">@capture</span>(label, <span class="hljs-property">@clone</span>(rules), continuation, scope, <span class="hljs-property">@engine</span>.DOWN)
      <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Load &amp; evaluate stylesheet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-string">"load"</span>: 
    <span class="hljs-attribute">command</span>: (operation, continuation, scope, meta, 
              node, type, method = <span class="hljs-string">'GET'</span>)<span class="hljs-function"> -&gt;</span>
      src = node.href || node.src || node
      type ||= node.type || <span class="hljs-string">'text/gss'</span>
      xhr = <span class="hljs-keyword">new</span> XMLHttpRequest()
      xhr.<span class="hljs-function"><span class="hljs-title">onreadystatechange</span> = =&gt;</span>
        <span class="hljs-keyword">if</span> xhr.readyState == <span class="hljs-number">4</span>
          <span class="hljs-keyword">if</span> xhr.status == <span class="hljs-number">200</span>
            <span class="hljs-property">@eval</span>.command.call(@, operation, continuation, scope, meta,
                                  node, type, xhr.responseText, src)
      xhr.open(method.toUpperCase(), src)
      xhr.send()

<span class="hljs-keyword">for</span> property, fn <span class="hljs-keyword">of</span> <span class="hljs-attribute">Rules</span>::
  fn.rule = <span class="hljs-literal">true</span>



<span class="hljs-built_in">module</span>.exports = Rules</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
