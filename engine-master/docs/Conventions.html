<!DOCTYPE html>

<html>
<head>
  <title>Conventions.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docs.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Document.html">
                Document.coffee
              </a>
            
              
              <a class="source" href="Engine.html">
                Engine.coffee
              </a>
            
              
              <a class="source" href="Parser.html">
                Parser.coffee
              </a>
            
              
              <a class="source" href="Solver.html">
                Solver.coffee
              </a>
            
              
              <a class="source" href="Algebra.html">
                Algebra.coffee
              </a>
            
              
              <a class="source" href="Constraints.html">
                Constraints.coffee
              </a>
            
              
              <a class="source" href="Conventions.html">
                Conventions.coffee
              </a>
            
              
              <a class="source" href="Measurements.html">
                Measurements.coffee
              </a>
            
              
              <a class="source" href="Native.html">
                Native.coffee
              </a>
            
              
              <a class="source" href="Rules.html">
                Rules.coffee
              </a>
            
              
              <a class="source" href="Selectors.html">
                Selectors.coffee
              </a>
            
              
              <a class="source" href="Transformations.html">
                Transformations.coffee
              </a>
            
              
              <a class="source" href="Types.html">
                Types.coffee
              </a>
            
              
              <a class="source" href="Units.html">
                Units.coffee
              </a>
            
              
              <a class="source" href="Buffer.html">
                Buffer.coffee
              </a>
            
              
              <a class="source" href="Command.html">
                Command.coffee
              </a>
            
              
              <a class="source" href="Console.html">
                Console.coffee
              </a>
            
              
              <a class="source" href="EventTrigger.html">
                EventTrigger.coffee
              </a>
            
              
              <a class="source" href="Helper.html">
                Helper.coffee
              </a>
            
              
              <a class="source" href="Property.html">
                Property.coffee
              </a>
            
              
              <a class="source" href="Style.html">
                Style.coffee
              </a>
            
              
              <a class="source" href="Expressions.html">
                Expressions.coffee
              </a>
            
              
              <a class="source" href="Queries.html">
                Queries.coffee
              </a>
            
              
              <a class="source" href="Values.html">
                Values.coffee
              </a>
            
              
              <a class="source" href="Restyles.html">
                Restyles.coffee
              </a>
            
              
              <a class="source" href="Solutions.html">
                Solutions.coffee
              </a>
            
              
              <a class="source" href="Dimensions.html">
                Dimensions.coffee
              </a>
            
              
              <a class="source" href="Equasions.html">
                Equasions.coffee
              </a>
            
              
              <a class="source" href="Styles.html">
                Styles.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Conventions.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Dynamic systems need to be able to clean up side effects.
Instead of linking effects explicitly, we generate 
unique tracking labels with special delimeters.
Together they enable bottom-up evaluation and 
stateless continuations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Conventions</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3 id="delimeters">Delimeters</h3>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><strong>↑ Referencing</strong>, e.g. to jump to results of dom query,
or to figure out which element in that collection 
called this function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">UP</span>:    <span class="hljs-string">'↑'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><strong>→ Linking</strong>, that allows lazy evaluation, by making arguments
depend on previously resolved arguments,
e.g. for plural binding or to generate unique argument signature</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">RIGHT</span>: <span class="hljs-string">'→'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong>↓ Nesting</strong>, as a way for expressions to own side effects,
e.g. to remove stylesheet, css rule or conditional branch</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">DOWN</span>:  <span class="hljs-string">'↓'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3 id="example">Example</h3>
<p>It’s a lot easier to clean up stateless systems. 
Whenever a string key is set to be cleaned up,
it broadcasts that intent to all subsystems, 
like constraint solver, dom observer, etc.
So they can clean up things related to that key
by triggering more remove commands for known sub-keys.</p>
<p>This removal cascade allows components to have strict
and arbitarily deep hierarchy, without knowing of it.</p>
<h2 id="-"> </h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    &lt;!-- Example <span class="hljs-keyword">of</span> <span class="hljs-built_in">document</span> -<span class="hljs-function">-&gt;</span>
    &lt;style id=<span class="hljs-string">"my-stylesheet"</span>&gt;
      (h1 !+ img)[width] == <span class="hljs-comment">#header[width]</span>
    &lt;/style&gt;
    &lt;header id=<span class="hljs-string">"header"</span>&gt;
      &lt;img&gt;
      &lt;h1 id=<span class="hljs-string">"h1"</span>&gt;&lt;/h1&gt;
    &lt;/header&gt;

    &lt;!-- Generated constraint key -<span class="hljs-function">-&gt;</span>
    style$my-stylesheet   <span class="hljs-comment"># my stylesheet</span>
               ↓ h1$h1    <span class="hljs-comment"># found heading</span>
               ↑ !+img    <span class="hljs-comment"># preceeded by image</span>
               → <span class="hljs-comment">#header  # bound to header element###</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3 id="methods">Methods</h3>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Return concatenated path for a given object and prefix
Removes trailing delimeter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getContinuation</span>: <span class="hljs-function"><span class="hljs-params">(path, value, suffix = <span class="hljs-string">''</span>)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> path
      path = path.replace(<span class="hljs-regexp">/[→↓↑]$/</span>, <span class="hljs-string">''</span>)
    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'string'</span>
    <span class="hljs-keyword">return</span> path + (value &amp;&amp; <span class="hljs-property">@identify</span>(value) || <span class="hljs-string">''</span>) + suffix</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>When cleaning a path, also clean forks, rules and pairs
This is a little bit of necessary evil.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getPossibleContinuations</span>: <span class="hljs-function"><span class="hljs-params">(path)</span> -&gt;</span>
    [path, path + <span class="hljs-property">@UP</span>, path + <span class="hljs-property">@RIGHT</span>, path + <span class="hljs-property">@DOWN</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Return computed path for id and property e.g. $id[property]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getPath</span>: <span class="hljs-function"><span class="hljs-params">(id, property)</span> -&gt;</span>
    <span class="hljs-keyword">unless</span> property
      property = id
      id = <span class="hljs-literal">undefined</span>
    <span class="hljs-keyword">if</span> property.indexOf(<span class="hljs-string">'['</span>) &gt; -<span class="hljs-number">1</span> || !id
      <span class="hljs-keyword">return</span> property
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> id + <span class="hljs-string">'['</span> + property + <span class="hljs-string">']'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Hook: Should interpreter iterate returned object?
(yes, if it’s a collection of objects or empty array)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isCollection</span>: <span class="hljs-function"><span class="hljs-params">(object)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> object &amp;&amp; object.length != <span class="hljs-literal">undefined</span> &amp;&amp; !object.substring &amp;&amp; !object.nodeType
      <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> object[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">when</span> <span class="hljs-string">"object"</span>
          <span class="hljs-keyword">return</span> object[<span class="hljs-number">0</span>].nodeType
        <span class="hljs-keyword">when</span> <span class="hljs-string">"undefined"</span>
          <span class="hljs-keyword">return</span> object.length == <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Return shared absolute path of a dom query ($id selector) </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getQueryPath</span>: <span class="hljs-function"><span class="hljs-params">(operation, continuation)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> continuation
      <span class="hljs-keyword">if</span> continuation.nodeType
        <span class="hljs-keyword">return</span> <span class="hljs-property">@identify</span>(continuation) + <span class="hljs-string">' '</span> + operation.path
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> continuation + operation.key
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> operation.key</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Remove all fork marks from a path. 
Allows multiple selector paths have shared destination </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getCanonicalPath</span>: <span class="hljs-function"><span class="hljs-params">(continuation, compact)</span> -&gt;</span>
    bits = <span class="hljs-property">@getContinuation</span>(continuation).split(<span class="hljs-property">@DOWN</span>);
    last = bits[bits.length - <span class="hljs-number">1</span>]
    last = bits[bits.length - <span class="hljs-number">1</span>] = last.split(<span class="hljs-property">@RIGHT</span>).pop().replace(<span class="hljs-property">@CanonicalizeRegExp</span>, <span class="hljs-string">''</span>)
    <span class="hljs-keyword">return</span> last <span class="hljs-keyword">if</span> compact
    <span class="hljs-keyword">return</span> bits.join(<span class="hljs-property">@DOWN</span>)
  <span class="hljs-attribute">CanonicalizeRegExp</span>: <span class="hljs-regexp">/\$[^↑]+(?:↑|$)/g</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Get path for the scope that triggered the script 
(e.g. el matched by css rule)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getScopePath</span>: <span class="hljs-function"><span class="hljs-params">(continuation)</span> -&gt;</span>
    bits = continuation.split(<span class="hljs-property">@DOWN</span>)
    bits[bits.length - <span class="hljs-number">1</span>] = <span class="hljs-string">""</span>
    <span class="hljs-keyword">return</span> bits.join(<span class="hljs-property">@DOWN</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Return path for given operation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getOperationPath</span>: <span class="hljs-function"><span class="hljs-params">(operation, continuation)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> continuation?
      <span class="hljs-keyword">if</span> operation.def.serialized &amp;&amp; !operation.def.hidden
        <span class="hljs-keyword">return</span> continuation + (operation.key || operation.path)
      <span class="hljs-keyword">return</span> continuation
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> operation.path</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Return element that is used as a context for given DOM operation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getContext</span>: <span class="hljs-function"><span class="hljs-params">(args, operation, scope, node)</span> -&gt;</span>
    index = args[<span class="hljs-number">0</span>].def &amp;&amp; <span class="hljs-number">4</span> || <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (args.length != index &amp;&amp; (args[index]?.nodeType))
      <span class="hljs-keyword">return</span> args[index]
    <span class="hljs-keyword">if</span> !operation.bound
      <span class="hljs-keyword">return</span> <span class="hljs-property">@scope</span>
    <span class="hljs-keyword">return</span> scope;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Return name of intrinsic property used in property path </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getIntrinsicProperty</span>: <span class="hljs-function"><span class="hljs-params">(path)</span> -&gt;</span>
    index = path.indexOf(<span class="hljs-string">'intrinsic-'</span>)
    <span class="hljs-keyword">if</span> index &gt; -<span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> (last = path.indexOf(<span class="hljs-string">']'</span>, index)) == -<span class="hljs-number">1</span>
        last = <span class="hljs-literal">undefined</span>
      <span class="hljs-keyword">return</span> property = path.substring(index + <span class="hljs-number">10</span>, last)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Is the value numerical? Helps us to deal with detecting non-linear exps
Objects are allowed only if they define custom valueOf function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isPrimitive</span>: <span class="hljs-function"><span class="hljs-params">(object)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> object == <span class="hljs-string">'object'</span>
      <span class="hljs-keyword">return</span> object.valueOf != Object.prototype.valueOf
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Little shim for require.js so we dont have to carry it around</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-property">@require</span> ||= <span class="hljs-function"><span class="hljs-params">(string)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> string == <span class="hljs-string">'cassowary'</span>
    <span class="hljs-keyword">return</span> c
  bits = string.replace(<span class="hljs-string">''</span>, <span class="hljs-string">''</span>).split(<span class="hljs-string">'/'</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[bits[bits.length - <span class="hljs-number">1</span>]]
<span class="hljs-property">@module</span> ||= {}

<span class="hljs-built_in">module</span>.exports = Conventions</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
